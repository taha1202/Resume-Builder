@page "/login"
@inject AuthService AuthService
@inject NavigationManager Navigation
@layout EmptyLayout
<PageTitle>Login - ResumeCloud</PageTitle>

<div class="auth-page">
    <div class="auth-container">
        <div class="auth-header">
            <div class="auth-icon">📄</div>
            <h2>Welcome Back</h2>
            <p>Sign in to your account</p>
        </div>

        <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
            <div class="form-group">
                <label>Email</label>
                <InputText @bind-Value="loginModel.Email" class="form-control" placeholder="your@email.com" />
            </div>

            <div class="form-group">
                <label>Password</label>
                <InputText type="password" @bind-Value="loginModel.Password" class="form-control" placeholder="••••••••" />
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">@errorMessage</div>
            }

            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button type="submit" class="btn-submit" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>Signing in...</span>
                    }
                    else
                    {
                        <span>Sign In</span>
                    }
                </button>

                @* <button type="button" class="btn-secondary" @onclick="UseDemoAccount" disabled="@isLoading">
                    Use Demo Account
                </button> *@
            </div>
        </EditForm>

        <p class="auth-footer">
            Don't have an account? <a href="/signup">Sign up</a>
        </p>

        <a href="/" class="back-link">← Back to Home</a>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private string errorMessage = string.Empty;
    private bool isLoading = false;

    private async Task HandleLogin()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            var success = await AuthService.Login(loginModel.Email, loginModel.Password);

            if (success)
            {
                Navigation.NavigateTo("/dashboard");
                return;
            }

            errorMessage = "Invalid email or password";
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            errorMessage = "An unexpected error occurred. Check server logs.";
        }
        finally
        {
            isLoading = false;
        }
    }

    // Demo helper - idempotent and avoids the regular Login path if it fails
    // private async Task UseDemoAccount()
    // {
    //     isLoading = true;
    //     errorMessage = string.Empty;

    //     try
    //     {
    //         var demoEmail = "demo@example.com";
    //         var demoPassword = "DemoPassword123!";

    //         Ensure demo user exists and sign in directly (no password check)
    //         AuthService.SeedUser("Demo User", demoEmail, demoPassword, signIn: true);

    //         If for some reason not authenticated, force sign-in
    //         if (!AuthService.IsAuthenticated || AuthService.CurrentUser?.Email != demoEmail)
    //         {
    //             AuthService.ForceSignIn(demoEmail);
    //         }

    //         Navigation.NavigateTo("/dashboard");
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.Error.WriteLine(ex);
    //         errorMessage = "Demo login failed. See server logs.";
    //     }
    //     finally
    //     {
    //         isLoading = false;
    //     }
    // }
}

