@page "/editor/{TemplateId:int}"
@page "/editor/{TemplateId:int}/{ResumeId}"
@layout EmptyLayout
@inject ResumeService ResumeService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@using System.Text.Json
@using System.Text.RegularExpressions
@using System.Linq
@using ResumeBuilder.Components
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Resume Editor - ResumeCloud</PageTitle>

@if (isLoading)
{
    <div class="loader-wrapper">
        <div class="spinner"></div>
        <span class="loading-text">Loading editor...</span>
    </div>
}
else
{
    <div class="editor-page-container @(isPreviewMode ? "preview-active" : "")">

        @* --- HEADER --- *@
        <div class="editor-top-header">
            <div class="header-left">
                <button class="btn-back" @onclick="GoBack">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></svg>
                    <span>Templates</span>
                </button>
                <div class="header-divider"></div>
                <h2>@selectedTemplate?.Name</h2>
                <span class="save-status">
                    @if (isSaving)
                    {
                        <span class="status-saving">Saving...</span>
                    }
                    else if (!string.IsNullOrEmpty(lastSaveTime))
                    {

                        <span class="status-saved">Saved @lastSaveTime</span>
                    }
                </span>
            </div>
            <div class="header-right">
                <button class="btn-header btn-save" @onclick="() => SaveResume(false)" disabled="@isSaving">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></svg><span>Save</span>
                </button>
                <button class="btn-header btn-preview" @onclick="TogglePreview">
                    @if (isPreviewMode)
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>
                        <span>Edit</span>
     }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></svg>
                        <span>Preview</span>
     }
                </button>
                <button class="btn-header btn-download" @onclick="DownloadPDF">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></svg><span>Download PDF</span>
                </button>
            </div>
        </div>

        <div class="editor-main-content">
            @* --- LEFT PANEL (FORM) --- *@
            <div class="editor-left-panel">
                <div class="tab-navigation-container">
                    <div class="tab-navigation-wrap">
                        @foreach (var tab in new[] { "Personal", "Summary", "Education", "Experience", "Tech Skills", "Soft Skills", "Projects", "Certifications", "Academic", "Volunteer", "Activities" })
                        {
                            <button class="tab-btn @(activeTab == tab ? "active" : "")" @onclick='() => activeTab = tab'>@tab</button>
                        }
                    </div>
                </div>

                <div class="form-content-area scrollable">
                    @if (activeTab == "Personal")
                    {
                        <div class="form-section">
                            <h3>Personal Information</h3>
                            <div class="form-group"><label>Full Name *</label><input type="text" @bind="resume.FullName" class="form-control-styled" placeholder="John Doe" /></div>
                            <div class="form-row"><div class="form-col"><div class="form-group"><label>Email *</label><input type="email" @bind="resume.Email" class="form-control-styled" /></div></div><div class="form-col"><div class="form-group"><label>Phone *</label><input type="tel" @bind="resume.Phone" class="form-control-styled" /></div></div></div>
                            <div class="form-group"><label>Location *</label><input type="text" @bind="resume.Address" class="form-control-styled" /></div>
                            <div class="form-row"><div class="form-col"><div class="form-group"><label>LinkedIn</label><input type="text" @bind="resume.LinkedIn" class="form-control-styled" /></div></div><div class="form-col"><div class="form-group"><label>Website</label><input type="text" @bind="resume.Website" class="form-control-styled" /></div></div></div>
                        </div>
                    }
                    @if (activeTab == "Summary")
                    {
                        <div class="form-section"><h3>Professional Summary</h3><div class="form-group"><label>Summary</label><RichTextEditor @bind-Value="resume.Summary" /></div></div>
                    }
                    @if (activeTab == "Education")
                    {
                        <div class="form-section"><div class="section-header-row"><h3>Education</h3><button class="btn-add" @onclick="AddEducationEntry">+ Add</button></div>@foreach (var e in EducationList) {
                        <div class="entry-card"><div class="entry-card-body"><div class="form-group"><input @bind="e.Institution" placeholder="Institution" class="form-control-styled mb-2" /></div><div class="form-row"><div class="form-col"><input @bind="e.Degree" placeholder="Degree" class="form-control-styled" /></div><div class="form-col"><input @bind="e.FieldOfStudy" placeholder="Field" class="form-control-styled" /></div></div><div class="form-row three-col"><div class="form-col"><input @bind="e.StartDate" placeholder="Start" class="form-control-styled" /></div><div class="form-col"><input @bind="e.EndDate" placeholder="End" class="form-control-styled" /></div><div class="form-col"><input @bind="e.GPA" placeholder="GPA" class="form-control-styled" /></div></div></div><button class="btn-icon-delete full-width" @onclick="() => RemoveEducation(e)">Remove Entry</button></div>
                    }
    </div>
                }
                @if (activeTab == "Experience")
                {
                    <div class="form-section"><div class="section-header-row"><h3>Work Experience</h3><button class="btn-add" @onclick="AddExperienceEntry">+ Add</button></div>@foreach (var e in ExperienceList) {
                    <div class="entry-card"><div class="entry-card-body"><div class="form-row"><div class="form-col"><input @bind="e.Company" placeholder="Company" class="form-control-styled" /></div><div class="form-col"><input @bind="e.Position" placeholder="Position" class="form-control-styled" /></div></div><div class="form-group"><input @bind="e.Location" placeholder="Location" class="form-control-styled mt-2" /></div><div class="form-row"><div class="form-col"><input @bind="e.StartDate" placeholder="Start Date" class="form-control-styled" /></div><div class="form-col"><input @bind="e.EndDate" placeholder="End Date" class="form-control-styled" /></div></div><div class="form-group mt-2"><label>Description</label><RichTextEditor @bind-Value="e.Description" /></div></div><button class="btn-icon-delete full-width" @onclick="() => RemoveExperience(e)">Remove Entry</button></div>
                }
</div>
                                }
                @if (activeTab == "Tech Skills" || activeTab == "Soft Skills")
                {
                    var isT = activeTab == "Tech Skills"; var list = isT ? TechSkillsList : SoftSkillsList; var inp = isT ? newTechSkill : newSoftSkill;
                    <div class="form-section"><h3>@activeTab</h3><div class="skill-input-group"><input type="text" value="@inp" @onchange="@(e => { if (isT) newTechSkill = e.Value?.ToString() ?? ""; else newSoftSkill = e.Value?.ToString() ?? ""; })" @onkeyup="@(e => KeyUpSkill(e, isT ? "Tech" : "Soft"))" class="form-control-styled" placeholder="Add skill and press Enter..." /><button class="btn-add-skill" @onclick="@(() => { if (isT) AddTechSkill(); else AddSoftSkill(); })">Add</button></div><div class="skills-container">@foreach (var s in list) {
                    <span class="skill-pill">@s <button class="btn-remove-skill" @onclick="() => { if (isT) RemoveTechSkill(s); else RemoveSoftSkill(s); }">×</button></span>
                }
</div></div>
                                }
                @if (activeTab == "Projects")
                {
                    <div class="form-section"><div class="section-header-row"><h3>Projects</h3><button class="btn-add" @onclick="AddProjectEntry">+ Add</button></div>@foreach (var p in ProjectList) {
                    <div class="entry-card"><div class="entry-card-body"><div class="form-group"><input @bind="p.Name" placeholder="Project Name" class="form-control-styled" /></div><div class="form-group"><input @bind="p.Technologies" placeholder="Technologies used" class="form-control-styled" /></div><div class="form-group"><label>Description</label><RichTextEditor @bind-Value="p.Description" /></div><div class="form-group"><input @bind="p.Link" placeholder="Link URL" class="form-control-styled" /></div></div><button class="btn-icon-delete full-width" @onclick="() => RemoveProject(p)">Remove Entry</button></div>
                }
</div>
                                }
                @if (activeTab == "Certifications")
                {
                    <div class="form-section"><div class="section-header-row"><h3>Certifications</h3><button class="btn-add" @onclick="AddCertEntry">+ Add</button></div>@foreach (var c in CertList) {
                    <div class="entry-card"><div class="entry-card-body"><div class="form-row"><div class="form-col"><input @bind="c.Name" placeholder="Certificate Name" class="form-control-styled" /></div><div class="form-col"><input @bind="c.Issuer" placeholder="Issuer" class="form-control-styled" /></div></div><div class="form-row mt-2"><div class="form-col"><input @bind="c.Date" placeholder="Date" class="form-control-styled" /></div><div class="form-col"><input @bind="c.Link" placeholder="Link URL" class="form-control-styled" /></div></div></div><button class="btn-icon-delete full-width" @onclick="() => RemoveCert(c)">Remove Entry</button></div>
                }
</div>
                                }
                @if (activeTab == "Academic")
                {
                    <div class="form-section"><div class="section-header-row"><h3>Academic Projects</h3><button class="btn-add" @onclick="AddAcademicEntry">+ Add</button></div>@foreach (var a in AcademicList) {
                    <div class="entry-card"><div class="entry-card-body"><div class="form-group"><input @bind="a.Name" placeholder="Project Name" class="form-control-styled" /></div><div class="form-group"><input @bind="a.Course" placeholder="Course / Subject" class="form-control-styled" /></div><div class="form-group"><input @bind="a.Grade" placeholder="Grade (Optional)" class="form-control-styled" /></div><div class="form-group"><label>Description</label><RichTextEditor @bind-Value="a.Description" /></div></div><button class="btn-icon-delete full-width" @onclick="() => RemoveAcademic(a)">Remove Entry</button></div>
                }
</div>
                                }
                @if (activeTab == "Volunteer")
                {
                    <div class="form-section"><div class="section-header-row"><h3>Volunteer Work</h3><button class="btn-add" @onclick="AddVolunteerEntry">+ Add</button></div>@foreach (var v in VolunteerList) {
                    <div class="entry-card"><div class="entry-card-body"><div class="form-row"><div class="form-col"><input @bind="v.Organization" placeholder="Organization" class="form-control-styled" /></div><div class="form-col"><input @bind="v.Role" placeholder="Role" class="form-control-styled" /></div></div><div class="form-row mt-2"><div class="form-col"><input @bind="v.StartDate" placeholder="Start Date" class="form-control-styled" /></div><div class="form-col"><input @bind="v.EndDate" placeholder="End Date" class="form-control-styled" /></div></div><div class="form-group mt-2"><label>Description</label><RichTextEditor @bind-Value="v.Description" /></div></div><button class="btn-icon-delete full-width" @onclick="() => RemoveVolunteer(v)">Remove Entry</button></div>
                }
</div>
                                }
                @if (activeTab == "Activities")
                {
                    <div class="form-section"><div class="section-header-row"><h3>Activities</h3><button class="btn-add" @onclick="AddActivityEntry">+ Add</button></div>@foreach (var a in ActivityList) {
                    <div class="entry-card"><div class="entry-card-body"><div class="form-group"><input @bind="a.Organization" placeholder="Organization / Activity" class="form-control-styled" /></div><div class="form-group"><input @bind="a.Role" placeholder="Role / Position" class="form-control-styled" /></div><div class="form-row mt-2"><div class="form-col"><input @bind="a.StartDate" placeholder="Start Date" class="form-control-styled" /></div><div class="form-col"><input @bind="a.EndDate" placeholder="End Date" class="form-control-styled" /></div></div><div class="form-group mt-2"><label>Description</label><RichTextEditor @bind-Value="a.Description" /></div></div><button class="btn-icon-delete full-width" @onclick="() => RemoveActivity(a)">Remove Entry</button></div>
                }
</div>
                                }
            </div>
        </div>

        @* === RIGHT PANEL (PREVIEW) === *@
        <div class="editor-right-panel" id="resume-preview">
            <div class="resume-document" style="@GetTemplateContainerStyle()">
                @{
                    string color = selectedTemplate?.ColorScheme ?? "#2563EB";
                    string initials = string.IsNullOrWhiteSpace(resume.FullName) ? "U" : resume.FullName.Substring(0, 1).ToUpper();

                    // Icons matching PDF logic exactly
                    RenderFragment Icon(string p, string c) => @<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="@c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="@p" /></svg>;
                    string pEmail = "M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z M22 6l-10 7L2 6";
                    string pPhone = "M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.05 12.05 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.05 12.05 0 0 0 2.81.7A2 2 0 0 1 22 16.92z";
                    string pMap = "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6";
                    string pLink = "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71 M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71";
                    string pGlobe = "M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z M2 12h20";
                }

                @if (selectedTemplate?.Id == 7) // SIDEBAR (TEMPLATE 7)
                {
                    <div class="sidebar-left" style="width:30%; background-color:#EBEBEB; padding:20px; display:flex; flex-direction:column; gap:20px;">
                        <div style="background-color:@color; color:white; width:70px; height:90px; display:flex; align-items:center; justify-content:center; font-size:36px; font-weight:bold; border:3px solid white; margin:0 auto;">@initials</div>
                        <div style="border:1px solid #ccc; padding:10px;">
                            <h3 style="color:@color; margin:0 0 8px 0; font-size:12px; font-weight:bold;">CONTACT</h3>
                            <div style="font-size:10px; display:flex; flex-direction:column; gap:5px; word-break:break-word;">
                                @if (!string.IsNullOrEmpty(resume.Email))
                                {
                                    <div style="display:flex; gap:5px; align-items:center;">@Icon(pEmail, color) <span>@resume.Email</span></div>
                                }
                                @if (!string.IsNullOrEmpty(resume.Phone))
                                {
                                    <div style="display:flex; gap:5px; align-items:center;">@Icon(pPhone, color) <span>@resume.Phone</span></div>
                                }
                                @if (!string.IsNullOrEmpty(resume.Address))
                                {
                                    <div style="display:flex; gap:5px; align-items:center;">@Icon(pMap, color) <span>@resume.Address</span></div>
                                }
                                @if (!string.IsNullOrEmpty(resume.LinkedIn))
                                {
                                    <div style="display:flex; gap:5px; align-items:center;">@Icon(pLink, color) <span>@resume.LinkedIn</span></div>
                                }
                            </div>
                        </div>
                        @if (EducationList.Any())
                        {
                            <div><h3 style="color:@color; font-size:12px; margin-bottom:5px; font-weight:bold;">EDUCATION</h3>@foreach(var e in EducationList){
                            <div style="font-size:10px; margin-bottom:8px;"><strong>@e.Degree</strong><br />@e.Institution<br /><span style="color:#666;font-style:italic">@e.StartDate - @e.EndDate</span></div>
                        }
    </div>
                    }
                    @if (TechSkillsList.Any())
                    {
                        <div><h3 style="color:@color; font-size:12px; margin-bottom:5px; font-weight:bold;">SKILLS</h3>@foreach(var s in TechSkillsList){
                        <div style="font-size:10px;">• @s</div>
                    }
</div>
                                        }
                    @if (SoftSkillsList.Any())
                    {
                        <div><h3 style="color:@color; font-size:12px; margin-bottom:5px; font-weight:bold;">SOFT SKILLS</h3>@foreach(var s in SoftSkillsList){
                        <div style="font-size:10px;">• @s</div>
                    }
</div>
                                        }
                </div>
                <div class="content-right" style="width:70%; display:flex; flex-direction:column;">
                    <div style="background-color:@color; padding:30px; text-align:center; color:white;">
                        <h1 style="margin:0; font-size:34px; font-weight:bold; letter-spacing:1px;">@(string.IsNullOrWhiteSpace(resume.FullName) ? "JOHN DOE" : resume.FullName.ToUpper())</h1>
                        <p style="margin:10px 0 0 0; font-size:10px;">@StripHtml(resume.Summary ?? "")</p>
                    </div>
                    <div style="padding:20px; background:white; flex:1;">
                        @if (ExperienceList.Any())
                        {
                            <div style="background:#D4AF37; color:white; padding:2px 10px; font-weight:bold; font-size:12px; margin-bottom:10px;">EMPLOYMENT HISTORY</div>@foreach(var e in ExperienceList){
                            <div style="font-size:11px; margin-bottom:15px;"><strong>@e.Position</strong><br /><span style="font-style:italic;color:#555;">@e.Company | @e.StartDate - @e.EndDate</span><div style="margin-top:2px;">@StripHtml(e.Description ?? "")</div></div>
                        }
}
                        @if (ProjectList.Any())
                        {
                            <div style="background:#D4AF37; color:white; padding:2px 10px; font-weight:bold; font-size:12px; margin-bottom:10px; margin-top:20px;">PROJECTS</div>@foreach(var p in ProjectList){
                            <div style="font-size:11px; margin-bottom:10px;"><strong>@p.Name</strong><br /><span style="font-style:italic;color:#555;">@p.Technologies</span><div style="margin-top:2px;">@StripHtml(p.Description ?? "")</div></div>
                        }
}
                        @if (CertList.Any())
                        {
                            <div style="background:#D4AF37; color:white; padding:2px 10px; font-weight:bold; font-size:12px; margin-bottom:10px; margin-top:20px;">CERTIFICATIONS</div>@foreach(var c in CertList){
                            <div style="background:@color; color:white; padding:5px; font-size:10px; margin-bottom:5px;"><strong>@c.Name</strong><br />@c.Issuer</div>
                        }
}
                        @if (VolunteerList.Any())
                        {
                            <div style="background:#D4AF37; color:white; padding:2px 10px; font-weight:bold; font-size:12px; margin-bottom:10px; margin-top:20px;">VOLUNTEER</div>@foreach(var v in VolunteerList){
                            <div style="font-size:11px; margin-bottom:10px;"><strong>@v.Organization</strong><br />@v.Role<div style="margin-top:2px;">@StripHtml(v.Description ?? "")</div></div>
                        }
}
                        @if (AcademicList.Any())
                        {
                            <div style="background:#D4AF37; color:white; padding:2px 10px; font-weight:bold; font-size:12px; margin-bottom:10px; margin-top:20px;">ACADEMIC</div>@foreach(var a in AcademicList){
                            <div style="font-size:11px; margin-bottom:10px;"><strong>@a.Name</strong><br />@a.Course<div style="margin-top:2px;">@StripHtml(a.Description ?? "")</div></div>
                        }
}
                        @if (ActivityList.Any())
                        {
                            <div style="background:#D4AF37; color:white; padding:2px 10px; font-weight:bold; font-size:12px; margin-bottom:10px; margin-top:20px;">ACTIVITIES</div>@foreach(var a in ActivityList){
                            <div style="font-size:11px; margin-bottom:10px;"><strong>@a.Organization</strong><br />@a.Role<div style="margin-top:2px;">@StripHtml(a.Description ?? "")</div></div>
                        }
}
                    </div>
                </div>
                                }
                                else if (selectedTemplate?.Id == 8) // EXECUTIVE (TEMPLATE 8)
                {
                    <div style="display:flex; flex-direction:column; width:100%;">
                        <div style="background-color:@color; padding:25px; display:flex; align-items:center; color:white;">
                            <div style="width:80px; height:80px; background:white; color:@color; display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:bold;">@initials</div>
                            <div style="margin-left:20px;">
                                <h1 style="margin:0; font-size:26px; font-weight:bold;">@(string.IsNullOrWhiteSpace(resume.FullName) ? "JOHN DOE" : resume.FullName.ToUpper())</h1>
                                <div style="font-size:10px; margin-top:8px; display:flex; gap:15px;">
                                    @if (!string.IsNullOrEmpty(resume.Email))
                                    {
                                        <span style="display:flex; gap:4px; align-items:center;">@Icon(pEmail, "white") @resume.Email</span>
                                    }
                                    @if (!string.IsNullOrEmpty(resume.Phone))
                                    {
                                        <span style="display:flex; gap:4px; align-items:center;">@Icon(pPhone, "white") @resume.Phone</span>
                                    }
                                    @if (!string.IsNullOrEmpty(resume.Address))
                                    {
                                        <span style="display:flex; gap:4px; align-items:center;">@Icon(pMap, "white") @resume.Address</span>
                                    }
                                </div>
                            </div>
                        </div>
                        <div style="display:flex; padding:25px; flex:1;">
                            <div style="width:35%; padding-right:20px; border-right:1px solid #eee;">
                                @if (!string.IsNullOrEmpty(resume.Summary))
                                {
                                    <h4 style="color:@color; margin-bottom:5px; font-weight:bold;">PROFILE</h4>
                                    <p style="font-size:10px; margin-bottom:15px;">@StripHtml(resume.Summary)</p>
    }
                                @if (TechSkillsList.Any())
                                {
                                    <h4 style="color:@color; margin-bottom:8px; font-weight:bold;">SKILLS</h4>@foreach(var s in TechSkillsList){
                                    <div style="font-size:10px; margin-bottom:2px;">• @s</div>
                                }
}
                            @if (EducationList.Any())
                            {
                                <h4 style="color:@color; margin-top:20px; margin-bottom:8px; font-weight:bold;">EDUCATION</h4>@foreach(var e in EducationList){
                                <div style="font-size:10px; margin-bottom:8px;"><strong>@e.Degree</strong><br />@e.Institution</div>
                            }
}
                        </div>
                        <div style="width:65%; padding-left:20px;">
                            @if (ExperienceList.Any())
                            {
                                <h4 style="color:@color; margin-bottom:10px; font-weight:bold;">EXPERIENCE</h4>@foreach(var e in ExperienceList){
                                <div style="font-size:11px; margin-bottom:15px;"><strong>@e.Position</strong><br /><span style="color:#666;font-style:italic">@e.Company | @e.StartDate - @e.EndDate</span><div style="margin-top:3px;">@StripHtml(e.Description ?? "")</div></div>
                            }
}
                            @if (ProjectList.Any())
                            {
                                <h4 style="color:@color; margin-bottom:10px; margin-top:20px; font-weight:bold;">PROJECTS</h4>@foreach(var p in ProjectList){
                                <div style="font-size:11px; margin-bottom:10px;"><strong>@p.Name</strong><div style="margin-top:3px;">@StripHtml(p.Description ?? "")</div></div>
                            }
}
                            @if (CertList.Any())
                            {
                                <h4 style="color:@color; margin-bottom:10px; margin-top:20px; font-weight:bold;">CERTIFICATIONS</h4>@foreach(var c in CertList){
                                <div style="font-size:11px; margin-bottom:10px;"><strong>@c.Name</strong> - @c.Issuer</div>
                            }
}
                            @if (VolunteerList.Any())
                            {
                                <h4 style="color:@color; margin-bottom:10px; margin-top:20px; font-weight:bold;">VOLUNTEER</h4>@foreach(var v in VolunteerList){
                                <div style="font-size:11px; margin-bottom:10px;"><strong>@v.Organization</strong><br />@v.Role</div>
                            }
}
                            @if (AcademicList.Any())
                            {
                                <h4 style="color:@color; margin-bottom:10px; margin-top:20px; font-weight:bold;">ACADEMIC</h4>@foreach(var a in AcademicList){
                                <div style="font-size:11px; margin-bottom:10px;"><strong>@a.Name</strong><br />@a.Course</div>
                            }
}
                            @if (ActivityList.Any())
                            {
                                <h4 style="color:@color; margin-bottom:10px; margin-top:20px; font-weight:bold;">ACTIVITIES</h4>@foreach(var a in ActivityList){
                                <div style="font-size:11px; margin-bottom:10px;"><strong>@a.Organization</strong><br />@a.Role</div>
                            }
}
                        </div>
                    </div>
                </div>
                                }
                                else if (selectedTemplate?.Id == 9) // CREATIVE (TEMPLATE 9)
                {
                    <div style="display:flex; width:100%; min-height:100%;">
                        <div style="width:35%; background-color:@color; color:white; padding:25px; display:flex; flex-direction:column; gap:20px;">
                            <div style="width:100px; height:100px; background:rgba(255,255,255,0.2); margin:0 auto; display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:bold;">@initials</div>
                            <div>
                                <h4 style="border-bottom:1px solid rgba(255,255,255,0.5); padding-bottom:5px; margin-bottom:10px;">CONTACT</h4>
                                <div style="font-size:10px; display:flex; flex-direction:column; gap:8px; word-break:break-word;">
                                    @if (!string.IsNullOrEmpty(resume.Email))
                                    {
                                        <div style="display:flex; gap:5px; align-items:center;">@Icon(pEmail, "white") @resume.Email</div>
                                    }
                                    @if (!string.IsNullOrEmpty(resume.Phone))
                                    {
                                        <div style="display:flex; gap:5px; align-items:center;">@Icon(pPhone, "white") @resume.Phone</div>
                                    }
                                    @if (!string.IsNullOrEmpty(resume.Address))
                                    {
                                        <div style="display:flex; gap:5px; align-items:center;">@Icon(pMap, "white") @resume.Address</div>
                                    }
                                </div>
                            </div>
                            @if (TechSkillsList.Any())
                            {
                                <div><h4 style="border-bottom:1px solid rgba(255,255,255,0.5); padding-bottom:5px; margin-bottom:10px;">SKILLS</h4><div style="display:flex; flex-wrap:wrap; gap:5px;">@foreach(var s in TechSkillsList){
                                <span style="background:rgba(255,255,255,0.2); padding:2px 6px; font-size:10px;">@s</span>
                            }
    </div></div>
                        }
                    </div>
                    <div style="width:65%; padding:30px; background:white;">
                        <h1 style="color:@color; font-size:30px; margin:0 0 5px 0; font-weight:bold;">@(string.IsNullOrWhiteSpace(resume.FullName) ? "JOHN DOE" : resume.FullName.ToUpper())</h1>
                        <div style="width:50px; height:4px; background:@color; margin-bottom:20px;"></div>
                        @if (!string.IsNullOrEmpty(resume.Summary))
                        {
                            <h4 style="color:@color; margin-bottom:5px; font-weight:bold;">ABOUT ME</h4>
                            <p style="font-size:10px; margin-bottom:20px;">@StripHtml(resume.Summary)</p>
}
                        @if (ExperienceList.Any())
                        {
                            <h4 style="color:@color; margin-bottom:10px; font-weight:bold;">EXPERIENCE</h4>@foreach(var e in ExperienceList){
                            <div style="font-size:11px; margin-bottom:15px;"><strong>@e.Position</strong><br />@e.Company<div style="margin-top:3px;">@StripHtml(e.Description ?? "")</div></div>
                        }
}
                        @if (ProjectList.Any())
                        {
                            <h4 style="color:@color; margin-bottom:10px; margin-top:20px; font-weight:bold;">PROJECTS</h4>@foreach(var p in ProjectList){
                            <div style="font-size:11px; margin-bottom:10px;"><strong>@p.Name</strong><br />@p.Technologies<div style="margin-top:3px;">@StripHtml(p.Description ?? "")</div></div>
                        }
}
                        @if (AcademicList.Any())
                        {
                            <h4 style="color:@color; margin-bottom:10px; margin-top:20px; font-weight:bold;">ACADEMIC</h4>@foreach(var a in AcademicList){
                            <div style="font-size:11px; margin-bottom:10px;"><strong>@a.Name</strong><br />@a.Course</div>
                        }
}
                        @if (VolunteerList.Any())
                        {
                            <h4 style="color:@color; margin-bottom:10px; margin-top:20px; font-weight:bold;">VOLUNTEER</h4>@foreach(var v in VolunteerList){
                            <div style="font-size:11px; margin-bottom:10px;"><strong>@v.Organization</strong><br />@v.Role</div>
                        }
}
                        @if (ActivityList.Any())
                        {
                            <h4 style="color:@color; margin-bottom:10px; margin-top:20px; font-weight:bold;">ACTIVITIES</h4>@foreach(var a in ActivityList){
                            <div style="font-size:11px; margin-bottom:10px;"><strong>@a.Organization</strong><br />@a.Role</div>
                        }
}
                    </div>
                </div>
                                }
                                else // STANDARD (TEMPLATE 1-6)
                {
                    <div style="border-bottom:3px solid @color; padding-bottom:15px; margin-bottom:20px;">
                        <h1 style="margin:0 0 10px 0; font-size:32px; font-weight:bold; color:black;">@(string.IsNullOrWhiteSpace(resume.FullName) ? "John Doe" : resume.FullName)</h1>
                        @* Contact Info ABOVE the line *@
                        <div style="display:flex; gap:15px; flex-wrap:wrap; color:#4B5563; font-size:10px;">
                            <span style="display:flex; align-items:center; gap:4px;">@Icon(pEmail, "#6B7280") @resume.Email</span>
                            @if (!string.IsNullOrEmpty(resume.Phone))
                            {
                                <span style="display:flex; align-items:center; gap:4px;">@Icon(pPhone, "#6B7280") @resume.Phone</span>
                            }
                            @if (!string.IsNullOrEmpty(resume.Address))
                            {
                                <span style="display:flex; align-items:center; gap:4px;">@Icon(pMap, "#6B7280") @resume.Address</span>
                            }
                            @if (!string.IsNullOrEmpty(resume.LinkedIn))
                            {
                                <span style="display:flex; align-items:center; gap:4px;">@Icon(pLink, "#6B7280") LinkedIn</span>
                            }
                            @if (!string.IsNullOrEmpty(resume.Website))
                            {
                                <span style="display:flex; align-items:center; gap:4px;">@Icon(pGlobe, "#6B7280") Website</span>
                            }
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:15px;">
                        @if (!string.IsNullOrWhiteSpace(resume.Summary))
                        {
                            <div><h2 style="color:@color; font-size:12px; font-weight:bold; margin-bottom:5px;">PROFESSIONAL SUMMARY</h2><div style="font-size:10px; line-height:1.4;">@StripHtml(resume.Summary)</div></div>
                        }
                        @if (ExperienceList.Any())
                        {
                            <div><h2 style="color:@color; font-size:12px; font-weight:bold; margin-bottom:5px;">EXPERIENCE</h2>@foreach(var e in ExperienceList){
                            <div style="margin-bottom:10px; font-size:10px;"><div style="display:flex; justify-content:space-between; font-weight:bold;"><span>@e.Position</span><span>@e.StartDate - @e.EndDate</span></div><div style="color:#666; font-style:italic">@e.Company | @e.Location</div><div style="margin-top:2px;">@StripHtml(e.Description ?? "")</div></div>
                        }
    </div>
                    }
                    @if (EducationList.Any())
                    {
                        <div><h2 style="color:@color; font-size:12px; font-weight:bold; margin-bottom:5px;">EDUCATION</h2>@foreach(var item in EducationList){
                        <div style="margin-bottom:8px; font-size:10px;"><div style="display:flex; justify-content:space-between; font-weight:bold;"><span>@item.Institution</span><span>@item.StartDate - @item.EndDate</span></div><div>@item.Degree in @item.FieldOfStudy</div></div>
                    }
</div>
                                        }
                    @if (TechSkillsList.Any())
                    {
                        <div><h2 style="color:@color; font-size:12px; font-weight:bold; margin-bottom:5px;">TECHNICAL SKILLS</h2><div style="display:flex; flex-wrap:wrap; gap:5px;">@foreach(var s in TechSkillsList){
                        <span style="background:#f3f4f6; padding:2px 8px; font-size:9px; border-radius:4px; color:#374151;">@s</span>
                    }
</div></div>
                                        }
                    @if (SoftSkillsList.Any())
                    {
                        <div><h2 style="color:@color; font-size:12px; font-weight:bold; margin-bottom:5px;">SOFT SKILLS</h2><div style="display:flex; flex-wrap:wrap; gap:5px;">@foreach(var s in SoftSkillsList){
                        <span style="background:#f3f4f6; padding:2px 8px; font-size:9px; border-radius:4px; color:#374151;">@s</span>
                    }
</div></div>
                                        }
                    @if (ProjectList.Any())
                    {
                        <div><h2 style="color:@color; font-size:12px; font-weight:bold; margin-bottom:5px;">PROJECTS</h2>@foreach(var p in ProjectList){
                        <div style="margin-bottom:8px; font-size:10px;"><div style="font-weight:bold;">@p.Name <span style="font-weight:normal;font-size:9px;color:@color">@(string.IsNullOrEmpty(p.Link) ? "" : "🔗")</span></div><div style="font-style:italic; color:#555;">@p.Technologies</div><div>@StripHtml(p.Description ?? "")</div></div>
                    }
</div>
                                        }
                    @if (CertList.Any())
                    {
                        <div><h2 style="color:@color; font-size:12px; font-weight:bold; margin-bottom:5px;">CERTIFICATIONS</h2>@foreach(var c in CertList){
                        <div style="margin-bottom:5px; font-size:10px;"><strong>@c.Name</strong> - @c.Issuer (@c.Date)</div>
                    }
</div>
                                        }
                    @if (AcademicList.Any())
                    {
                        <div><h2 style="color:@color; font-size:12px; font-weight:bold; margin-bottom:5px;">ACADEMIC ACHIEVEMENTS</h2>@foreach(var a in AcademicList){
                        <div style="margin-bottom:8px; font-size:10px;"><strong>@a.Name</strong><br />@a.Course</div>
                    }
</div>
                                        }
                    @if (VolunteerList.Any())
                    {
                        <div><h2 style="color:@color; font-size:12px; font-weight:bold; margin-bottom:5px;">VOLUNTEER EXPERIENCE</h2>@foreach(var v in VolunteerList){
                        <div style="margin-bottom:8px; font-size:10px;"><strong>@v.Organization</strong><br />@v.Role (@v.StartDate - @v.EndDate)</div>
                    }
</div>
                                        }
                    @if (ActivityList.Any())
                    {
                        <div><h2 style="color:@color; font-size:12px; font-weight:bold; margin-bottom:5px;">ACTIVITIES & INTERESTS</h2>@foreach(var a in ActivityList){
                        <div style="margin-bottom:8px; font-size:10px;"><strong>@a.Organization</strong><br />@a.Role</div>
                    }
</div>
                                        }
                </div>
                                }
            </div>
        </div>
    </div>
</div>
}

@code {
    [Parameter] public int TemplateId { get; set; }
    [Parameter] public string ResumeId { get; set; } = "";
    private Resume resume = new();
    private ResumeTemplate? selectedTemplate;
    private string activeTab = "Personal";
    private bool isPreviewMode = false;
    private bool isSaving = false;
    private bool isLoading = true;
    private string lastSaveTime = "";

    private void TogglePreview() => isPreviewMode = !isPreviewMode;

    // View Models
    public class EducationEntry { public string Institution { get; set; } = ""; public string Degree { get; set; } = ""; public string FieldOfStudy { get; set; } = ""; public string StartDate { get; set; } = ""; public string EndDate { get; set; } = ""; public string GPA { get; set; } = ""; }
    public class ExperienceEntry { public string Company { get; set; } = ""; public string Position { get; set; } = ""; public string Location { get; set; } = ""; public string StartDate { get; set; } = ""; public string EndDate { get; set; } = ""; public string Description { get; set; } = ""; }
    public class ProjectEntry { public string Name { get; set; } = ""; public string Description { get; set; } = ""; public string Technologies { get; set; } = ""; public string Link { get; set; } = ""; }
    public class CertEntry { public string Name { get; set; } = ""; public string Issuer { get; set; } = ""; public string Date { get; set; } = ""; public string Link { get; set; } = ""; }
    public class AcademicEntry { public string Name { get; set; } = ""; public string Course { get; set; } = ""; public string Grade { get; set; } = ""; public string Description { get; set; } = ""; }
    public class VolunteerEntry { public string Organization { get; set; } = ""; public string Role { get; set; } = ""; public string StartDate { get; set; } = ""; public string EndDate { get; set; } = ""; public string Description { get; set; } = ""; }
    public class ActivityEntry { public string Organization { get; set; } = ""; public string Role { get; set; } = ""; public string StartDate { get; set; } = ""; public string EndDate { get; set; } = ""; public string Description { get; set; } = ""; }

    private List<EducationEntry> EducationList = new();
    private List<ExperienceEntry> ExperienceList = new();
    private List<ProjectEntry> ProjectList = new();
    private List<CertEntry> CertList = new();
    private List<string> TechSkillsList = new();
    private List<string> SoftSkillsList = new();
    private List<AcademicEntry> AcademicList = new();
    private List<VolunteerEntry> VolunteerList = new();
    private List<ActivityEntry> ActivityList = new();
    private string newTechSkill = "";
    private string newSoftSkill = "";

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        await AuthService.InitializeAsync();
        if (string.IsNullOrEmpty(AuthService.AuthToken)) { Navigation.NavigateTo("/"); return; }
        var currentUserId = AuthService.CurrentUser?.Id;
        selectedTemplate = ResumeService.GetTemplate(TemplateId) ?? new ResumeTemplate { Name = "Modern Template", ColorScheme = "#2563EB" };
        if (!string.IsNullOrEmpty(ResumeId)) { var existingResume = await ResumeService.GetResume(ResumeId, currentUserId); if (existingResume != null) { resume = existingResume; DeserializeData(); } }
        else { resume.TemplateId = TemplateId; resume.UserId = AuthService.CurrentUser?.Id ?? "rafay"; resume.Email = AuthService.CurrentUser?.Email ?? ""; resume.FullName = AuthService.CurrentUser?.Name ?? ""; }
        isLoading = false;
    }

    private void DeserializeData()
    {
        try { EducationList = string.IsNullOrEmpty(resume.Education) ? new() : JsonSerializer.Deserialize<List<EducationEntry>>(resume.Education!) ?? new(); } catch { }
        try { ExperienceList = string.IsNullOrEmpty(resume.Experience) ? new() : JsonSerializer.Deserialize<List<ExperienceEntry>>(resume.Experience!) ?? new(); } catch { }
        try { ProjectList = string.IsNullOrEmpty(resume.Projects) ? new() : JsonSerializer.Deserialize<List<ProjectEntry>>(resume.Projects!) ?? new(); } catch { }
        try { CertList = string.IsNullOrEmpty(resume.Certifications) ? new() : JsonSerializer.Deserialize<List<CertEntry>>(resume.Certifications!) ?? new(); } catch { }
        if (!string.IsNullOrEmpty(resume.Skills)) TechSkillsList = resume.Skills!.Trim().StartsWith("[") ? JsonSerializer.Deserialize<List<string>>(resume.Skills!) : resume.Skills!.Split(',').Select(s => s.Trim()).Where(s => !string.IsNullOrEmpty(s)).ToList();
        if (!string.IsNullOrEmpty(resume.SoftSkills)) SoftSkillsList = resume.SoftSkills!.Trim().StartsWith("[") ? JsonSerializer.Deserialize<List<string>>(resume.SoftSkills!) : resume.SoftSkills!.Split(',').Select(s => s.Trim()).Where(s => !string.IsNullOrEmpty(s)).ToList();
        try { AcademicList = string.IsNullOrEmpty(resume.Academic) || !resume.Academic!.Trim().StartsWith("[") ? new() : JsonSerializer.Deserialize<List<AcademicEntry>>(resume.Academic!) ?? new(); } catch { }
        try { VolunteerList = string.IsNullOrEmpty(resume.Volunteer) || !resume.Volunteer!.Trim().StartsWith("[") ? new() : JsonSerializer.Deserialize<List<VolunteerEntry>>(resume.Volunteer!) ?? new(); } catch { }
        try { ActivityList = string.IsNullOrEmpty(resume.Activities) || !resume.Activities!.Trim().StartsWith("[") ? new() : JsonSerializer.Deserialize<List<ActivityEntry>>(resume.Activities!) ?? new(); } catch { }
    }

    private void SerializeData()
    {
        resume.Education = JsonSerializer.Serialize(EducationList);
        resume.Experience = JsonSerializer.Serialize(ExperienceList);
        resume.Projects = JsonSerializer.Serialize(ProjectList);
        resume.Certifications = JsonSerializer.Serialize(CertList);
        resume.Skills = JsonSerializer.Serialize(TechSkillsList);
        resume.SoftSkills = JsonSerializer.Serialize(SoftSkillsList);
        resume.Academic = JsonSerializer.Serialize(AcademicList);
        resume.Volunteer = JsonSerializer.Serialize(VolunteerList);
        resume.Activities = JsonSerializer.Serialize(ActivityList);
    }

    private async Task SaveResume(bool silent = false)
    {
        if (string.IsNullOrEmpty(resume.UserId)) return;
        if (!silent) { isSaving = true; StateHasChanged(); }
        SerializeData();
        await ResumeService.SaveResume(resume);
        lastSaveTime = DateTime.Now.ToString("h:mm tt");
        if (!silent) { isSaving = false; StateHasChanged(); }
    }

    private async Task DownloadPDF()
    {
        await SaveResume(silent: true);
        try
        {
            var cleanExp = ExperienceList.Select(e => new ExperienceEntry { Company = e.Company, Position = e.Position, Location = e.Location, StartDate = e.StartDate, EndDate = e.EndDate, Description = StripHtml(e.Description!) }).ToList();
            var cleanProj = ProjectList.Select(p => new ProjectEntry { Name = p.Name, Technologies = p.Technologies, Link = p.Link, Description = StripHtml(p.Description!) }).ToList();
            var cleanAcad = AcademicList.Select(a => new AcademicEntry { Name = a.Name, Course = a.Course, Grade = a.Grade, Description = StripHtml(a.Description!) }).ToList();
            var cleanVol = VolunteerList.Select(v => new VolunteerEntry { Organization = v.Organization, Role = v.Role, StartDate = v.StartDate, EndDate = v.EndDate, Description = StripHtml(v.Description!) }).ToList();
            var cleanAct = ActivityList.Select(a => new ActivityEntry { Organization = a.Organization, Role = a.Role, StartDate = a.StartDate, EndDate = a.EndDate, Description = StripHtml(a.Description!) }).ToList();

            var pdfResume = new Resume
            {
                Id = resume.Id,
                UserId = resume.UserId,
                TemplateId = resume.TemplateId,
                FullName = resume.FullName,
                Email = resume.Email,
                Phone = resume.Phone,
                Address = resume.Address,
                LinkedIn = resume.LinkedIn,
                Website = resume.Website,
                Summary = StripHtml(resume.Summary!),
                Education = JsonSerializer.Serialize(EducationList),
                Certifications = JsonSerializer.Serialize(CertList),
                Skills = string.Join(", ", TechSkillsList),
                SoftSkills = string.Join(", ", SoftSkillsList),
                Experience = JsonSerializer.Serialize(cleanExp),
                Projects = JsonSerializer.Serialize(cleanProj),
                Academic = JsonSerializer.Serialize(cleanAcad),
                Volunteer = JsonSerializer.Serialize(cleanVol),
                Activities = JsonSerializer.Serialize(cleanAct)
            };
            var pdfBytes = ResumeService.GeneratePDF(pdfResume, selectedTemplate);
            var base64 = Convert.ToBase64String(pdfBytes);
            var fileName = $"{resume.FullName.Replace(" ", "_")}_Resume.pdf";
            await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", fileName, "application/pdf", base64);
        }
        catch (Exception ex) { Console.WriteLine($"Error during PDF Download: {ex.Message}"); }
    }

    private string StripHtml(string input) { if (string.IsNullOrEmpty(input)) return string.Empty; var step1 = Regex.Replace(input, @"</p>|<br>|</li>", "\n"); var step2 = Regex.Replace(step1, "<.*?>", string.Empty); return System.Net.WebUtility.HtmlDecode(step2).Trim(); }
    private string GetTemplateContainerStyle() { if (selectedTemplate?.Id == 7 || selectedTemplate?.Id == 9) return "padding: 0; display: flex; flex-direction: row; min-height: 11in; align-items: stretch;"; if (selectedTemplate?.Id == 8) return "padding: 0; display: flex; flex-direction: column; min-height: 11in;"; return ""; }

    // CRUD Operations
    private void AddEducationEntry() => EducationList.Add(new EducationEntry()); private void RemoveEducation(EducationEntry item) => EducationList.Remove(item);
    private void AddExperienceEntry() => ExperienceList.Add(new ExperienceEntry()); private void RemoveExperience(ExperienceEntry item) => ExperienceList.Remove(item);
    private void AddProjectEntry() => ProjectList.Add(new ProjectEntry()); private void RemoveProject(ProjectEntry item) => ProjectList.Remove(item);
    private void AddCertEntry() => CertList.Add(new CertEntry()); private void RemoveCert(CertEntry item) => CertList.Remove(item);
    private void AddAcademicEntry() => AcademicList.Add(new AcademicEntry()); private void RemoveAcademic(AcademicEntry item) => AcademicList.Remove(item);
    private void AddVolunteerEntry() => VolunteerList.Add(new VolunteerEntry()); private void RemoveVolunteer(VolunteerEntry item) => VolunteerList.Remove(item);
    private void AddActivityEntry() => ActivityList.Add(new ActivityEntry()); private void RemoveActivity(ActivityEntry item) => ActivityList.Remove(item);
    private void AddTechSkill() { if (!string.IsNullOrWhiteSpace(newTechSkill)) { TechSkillsList.Add(newTechSkill.Trim()); newTechSkill = ""; } }
    private void RemoveTechSkill(string s) => TechSkillsList.Remove(s);
    private void AddSoftSkill() { if (!string.IsNullOrWhiteSpace(newSoftSkill)) { SoftSkillsList.Add(newSoftSkill.Trim()); newSoftSkill = ""; } }
    private void RemoveSoftSkill(string s) => SoftSkillsList.Remove(s);
    private void KeyUpSkill(KeyboardEventArgs e, string type) { if (e.Key == "Enter") { if (type == "Tech") AddTechSkill(); else AddSoftSkill(); } }
    private void GoBack() => Navigation.NavigateTo("/templates");
}

<style>
    /* Styles kept consistent with previous version */
    :root {
        --primary-color: #2563EB;
        --bg-app: #f3f4f6;
        --bg-panel-left: #ffffff;
        --bg-panel-right: #e5e7eb;
        --border-color: #e5e7eb;
        --text-dark: #111827;
        --text-medium: #374151;
        --text-light: #6b7280;
        --input-bg: #f9fafb;
    }

    .editor-page-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: var(--bg-app);
        font-family: 'Inter', sans-serif;
    }

    .loader-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        width: 100%;
        background-color: var(--bg-app);
        color: var(--text-light);
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #e5e7eb;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .loading-text {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-medium);
    }

    .editor-top-header {
        background: #ffffff;
        border-bottom: 1px solid var(--border-color);
        padding: 0 1.5rem;
        height: 64px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

        .header-left h2 {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

    .btn-back {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: transparent;
        border: none;
        color: var(--text-medium);
        font-weight: 500;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 6px;
    }

        .btn-back:hover {
            background: var(--bg-app);
        }

    .header-divider {
        height: 24px;
        width: 1px;
        background: var(--border-color);
    }

    .header-right {
        display: flex;
        gap: 0.75rem;
    }

    .btn-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-preview {
        background: var(--bg-app);
        border: 1px solid var(--border-color);
        color: var(--text-medium);
    }

        .btn-preview:hover {
            background: #e5e7eb;
        }

    .btn-download {
        background: var(--primary-color);
        border: 1px solid var(--primary-color);
        color: white;
    }

        .btn-download:hover {
            background: #1d4ed8;
        }

    .editor-main-content {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .editor-left-panel {
        width: 55%;
        max-width: 700px;
        background: var(--bg-panel-left);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
    }

    .editor-right-panel {
        flex: 1;
        background: var(--bg-panel-right);
        padding: 2rem;
        overflow-y: auto;
        display: flex;
        justify-content: center;
    }

    .preview-active .editor-left-panel {
        display: none !important;
    }

    .preview-active .editor-right-panel {
        width: 100% !important;
        display: flex !important;
    }

    @@media (max-width: 1024px) {
        .editor-left-panel {
            width: 100% !important;
            border-right: none;
        }

        .editor-right-panel {
            display: none;
        }

        .preview-active .editor-left-panel {
            display: none !important;
        }

        .preview-active .editor-right-panel {
            display: flex !important;
            width: 100% !important;
        }
    }

    .tab-navigation-container {
        padding: 1.5rem;
        padding-bottom: 1rem;
    }

    .tab-navigation-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        background: #f3f4f6;
        padding: 0.375rem;
        border-radius: 12px;
    }

    .tab-btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: none;
        background: transparent;
        color: var(--text-light);
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }

        .tab-btn:hover {
            color: var(--text-medium);
        }

        .tab-btn.active {
            background: #ffffff;
            color: var(--text-dark);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-weight: 600;
        }

    .form-content-area {
        padding: 0 1.5rem 2rem 1.5rem;
        overflow-y: auto;
        flex: 1;
    }

    .scrollable::-webkit-scrollbar {
        width: 6px;
    }

    .scrollable::-webkit-scrollbar-thumb {
        background-color: #d1d5db;
        border-radius: 10px;
    }

    .form-section h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1.25rem;
    }

    .section-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-medium);
            margin-bottom: 0.5rem;
        }

    .form-control-styled {
        width: 100%;
        padding: 0.75rem 1rem;
        background-color: var(--input-bg);
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.95rem;
        color: var(--text-dark);
        outline: none;
        transition: all 0.2s;
    }

        .form-control-styled:focus {
            background-color: #ffffff;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

    .form-row {
        display: flex;
        gap: 1rem;
    }

    .form-col {
        flex: 1;
    }

    .entry-card {
        background: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .entry-card-header {
        background: #f9fafb;
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .entry-title {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-dark);
    }

    .entry-card-body {
        padding: 1.25rem;
    }

    .btn-add {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .btn-icon-delete {
        background: transparent;
        border: none;
        cursor: pointer;
        color: red;
        padding: 4px;
        border-radius: 4px;
        display: flex;
        justify-content: center;
    }

        .btn-icon-delete:hover {
            background: #fee2e2;
        }

    .full-width {
        width: 100%;
        border-top: 1px solid #e5e7eb;
        border-radius: 0 0 12px 12px;
        padding: 8px;
    }

    .skill-input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .btn-add-skill {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0 1.25rem;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
    }

    .skills-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .skill-pill {
        background: #eff6ff;
        color: var(--primary-color);
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-remove-skill {
        background: transparent;
        border: none;
        color: inherit;
        cursor: pointer;
        font-size: 1.1rem;
        line-height: 1;
        padding: 0 2px;
        opacity: 0.6;
    }

        .btn-remove-skill:hover {
            opacity: 1;
        }

    .resume-document {
        width: 100%;
        max-width: 850px;
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        min-height: 11in;
        padding: 0.75in;
        color: #333;
    }

    .save-status {
        margin-left: 1rem;
        font-size: 0.85rem;
        color: var(--text-light);
    }

    .status-saving {
        color: var(--primary-color);
        font-weight: 500;
    }

    .btn-save {
        background: #ffffff;
        border: 1px solid #d1d5db;
        color: var(--text-dark);
    }

        .btn-save:hover {
            background: #f9fafb;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .btn-save:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
</style>